#!/bin/sh
#
# Check that commit message follows the Conventional Commits specification.
# https://www.conventionalcommits.org/en/v1.0.0/

commit_msg_file=$1
commit_msg=$(head -n1 "$commit_msg_file")

# Allow Merge commits
if echo "$commit_msg" | grep -q "^Merge"; then
    exit 0
fi

# Allow Revert commits
if echo "$commit_msg" | grep -q "^Revert"; then
    exit 0
fi

# Conventional Commits regex
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
# Scope: optional, in parentheses
# Breaking change: optional "!" after type/scope
# Subject: required, after ": "
regex="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?!?:\ .+"

if ! echo "$commit_msg" | grep -Eq "$regex"; then
    echo "Error: Commit message does not follow Conventional Commits format."
    echo "Format: <type>[optional scope]: <description>"
    echo "Example: feat(auth): add login support"
    echo "Allowed types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
    exit 1
fi
